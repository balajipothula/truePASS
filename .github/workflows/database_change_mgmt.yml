name: '🛢️ Database Change Management'
description: 'Liquibase GitHub Action for Database Change Management CI CD'

# This workflow requires the following configuration in Github
#
# Variables:
#   SUPABASE_PG_HOST     - Supabase Postgres Database Host URL.
#   SUPABASE_PG_DB_NAME  - Supabase Postgres Database Name.
#   SUPABASE_PG_USER     - Supabase Postgres Database Username.
#   SUPABASE_PG_PORT     - Supabase Postgres Database Host Port.
#
# Secrets:
#   SUPABASE_PG_PASSWORD - Supabase Postgres Database Password.

on:
  workflow_dispatch:
    inputs:
      apply_database_changes:
        type: boolean
        default: false
        description: 'Apply Database Change Management'
        required: false

jobs:
  job_db_change_mgmt:
    name: 🛢 Liquibase Update Action ᵛ⁴·³³·⁰
    if: ${{ inputs.apply_database_changes }}
    runs-on: ubuntu-22.04
    environment: ${{ github.ref }}
    defaults:
      run:
        shell: bash
    steps:
      # Checkout a Git repository at a particular version.
      - name: Step - Checkout ᵛ³
        uses: actions/checkout@v3
      # Gets the public IPv4 and IPv6 addreses of the current runner.
      - name: Step - Get Runner Public IP Address ᵛ¹·⁰·⁰
        id: step_candidob_get-runner-ip_v1-0-0
        uses: ./.github/actions/candidob_get-runner-ip_v1-0-0
      # Deploy any changes in the changelog file that have not been deployed
      - name: Step - Liquibase Update Action 🛢
        uses: ./.github/actions/liquibase-github-actions_update_v4.33.0
        with:
          changelogFile: "./liquibase/postgresql/ahooooy_db/master.xml"
          driver: "org.postgresql.Driver"
          url: "jdbc:postgresql://${{ vars.SUPABASE_PG_HOST }}:${{ vars.SUPABASE_PG_PORT }}/${{ vars.SUPABASE_PG_DB_NAME }}?prepareThreshold=0"
          username: ${{ vars.SUPABASE_PG_USER }}
          password: ${{ secrets.SUPABASE_PG_PASSWORD }}
          defaultSchemaName: "public"
          classpath: "./liquibase/postgresql/ahooooy_db/"
          rollbackOnError: true
          # Suppress Liquibase console output.
          logLevel: "SEVERE"
          mirrorConsoleMessagesToLog: false
          showBanner: false
          showSummary: "off"
          showSummaryOutput: "log"
